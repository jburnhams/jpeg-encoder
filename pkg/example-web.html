<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>jpeg-encoder-wasm web example</title>
    <style>
      body { font-family: sans-serif; }
      img { border: 1px solid #ccc; max-width: 200px; }
      pre { background: #f6f8fa; padding: 12px; }
    </style>
  </head>
  <body>
    <h1>jpeg-encoder-wasm</h1>
    <p>This example runs entirely in the browser using the curated <code>pkg/index.js</code> entrypoint.</p>
    <p>The wasm file must be served over HTTP next to this HTML page. One option:</p>
    <pre>npx serve pkg -l 4173</pre>

    <p>Encoded JPEG preview:</p>
    <img id="preview" alt="JPEG preview" />

    <script type="module">
      import init, { StreamingJpegEncoder, WasmColorType } from "./index.js";

      async function main() {
        await init();

        const width = 320;
        const height = 240;
        const stripHeight = 16; // multiple of the encoder's 8-row MCU height for RGB/YCbCr
        const encoder = new StreamingJpegEncoder(width, height, WasmColorType.Rgb, 90);

        const chunks = [];
        for (let y = 0; y < height; y += stripHeight) {
          const h = Math.min(stripHeight, height - y);
          const strip = new Uint8Array(width * h * 3);

          for (let row = 0; row < h; row++) {
            for (let x = 0; x < width; x++) {
              const idx = (row * width + x) * 3;
              strip[idx] = (x / width) * 255;
              strip[idx + 1] = ((y + row) / height) * 255;
              strip[idx + 2] = 200;
            }
          }

          const chunk = encoder.encode_strip(strip);
          if (chunk.length) chunks.push(chunk);
        }

        chunks.push(encoder.finish());

        const merged = new Uint8Array(chunks.reduce((sum, c) => sum + c.length, 0));
        let offset = 0;
        for (const chunk of chunks) {
          merged.set(chunk, offset);
          offset += chunk.length;
        }

        const url = URL.createObjectURL(new Blob([merged], { type: "image/jpeg" }));
        document.getElementById("preview").src = url;
      }

      main().catch((err) => {
        console.error("Failed to encode", err);
        document.getElementById("preview").alt = "Failed to encode (see console)";
      });
    </script>
  </body>
</html>
